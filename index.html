<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civitatis - Comparador de Operadores</title>
    <link rel="stylesheet" href="./static/style.css">
    <style>
        /* Tooltip styles */
        .calendar-day {
            position: relative;
        }
        .calendar-day.has-data {
            background: linear-gradient(135deg, var(--brand-green) 0%, #25a06a 100%);
            color: white;
            cursor: pointer;
        }
        .calendar-day.has-data:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 100;
            font-size: 12px;
        }
        .calendar-day:hover .tooltip {
            display: block;
        }
        .tooltip-header {
            font-weight: bold;
            color: var(--brand-orange);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .tooltip-schedule {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .tooltip-schedule:last-child {
            border-bottom: none;
        }
        .tooltip-time {
            font-weight: 600;
            color: #333;
        }
        .tooltip-operator {
            color: #666;
        }
        .tooltip-price {
            color: var(--brand-green);
            font-weight: 600;
        }
        .tooltip-quota {
            background: var(--brand-orange);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 4px;
        }
        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .last-update {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
        .refresh-btn {
            background: var(--brand-orange);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #d55a22;
        }
        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div style="text-align: center;">
            <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
            <p>Cargando datos...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Comparador de Operadores</h1>
            <p class="subtitle">Pasa el mouse sobre las fechas para ver horarios y proveedores</p>
        </header>

        <main>
            <div class="controls-section">
                <div class="form-group">
                    <label for="tour-select">Tour</label>
                    <select id="tour-select">
                        <option value="">Cargando tours...</option>
                    </select>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <button type="button" id="prev-month" class="calendar-nav">&lt;</button>
                        <span id="current-month">Enero 2026</span>
                        <button type="button" id="next-month" class="calendar-nav">&gt;</button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Lun</span>
                        <span>Mar</span>
                        <span>Mie</span>
                        <span>Jue</span>
                        <span>Vie</span>
                        <span>Sab</span>
                        <span>Dom</span>
                    </div>
                    <div id="calendar-days" class="calendar-days"></div>
                </div>

                <div id="last-update" class="last-update"></div>

                <div class="action-buttons" style="margin-top: 20px;">
                    <button type="button" id="refresh-btn" class="refresh-btn">
                        Actualizar Datos Ahora
                    </button>
                </div>
            </div>

            <div id="error-message" class="error-card" hidden>
                <strong>Error:</strong> <span id="error-text"></span>
            </div>
        </main>
    </div>

    <script>
        // API URL - Railway backend
        const API_URL = 'https://web-production-d27c8.up.railway.app';

        // State
        let currentDate = new Date();
        let calendarData = {};
        let tours = [];
        let selectedTourId = null;

        // DOM Elements
        const tourSelect = document.getElementById('tour-select');
        const calendarDays = document.getElementById('calendar-days');
        const currentMonthEl = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const lastUpdateEl = document.getElementById('last-update');
        const refreshBtn = document.getElementById('refresh-btn');
        const errorCard = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Month names in Spanish
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // Load tours on startup
        async function loadTours() {
            try {
                const response = await fetch(`${API_URL}/api/tours`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    tours = data.data;
                    tourSelect.innerHTML = tours.map(t =>
                        `<option value="${t.id}">${t.name}</option>`
                    ).join('');

                    selectedTourId = tours[0].id;
                    loadCalendarData();
                } else {
                    tourSelect.innerHTML = '<option value="">No hay tours configurados</option>';
                }
            } catch (error) {
                console.error('Error loading tours:', error);
                tourSelect.innerHTML = '<option value="">Error cargando tours</option>';
            }
        }

        // Load calendar data for selected tour
        async function loadCalendarData() {
            if (!selectedTourId) return;

            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch(`${API_URL}/api/calendar/${selectedTourId}`);
                const data = await response.json();

                if (data.success) {
                    calendarData = data.calendar || {};
                    renderCalendar();
                }

                // Get last scrape status
                const statusResponse = await fetch(`${API_URL}/api/scrape/status`);
                const statusData = await statusResponse.json();

                if (statusData.success && statusData.last_scrape) {
                    const lastScrape = statusData.last_scrape;
                    if (lastScrape.finished_at) {
                        const date = new Date(lastScrape.finished_at);
                        lastUpdateEl.textContent = `Ultima actualizacion: ${date.toLocaleString('es-ES')}`;
                    }
                }

            } catch (error) {
                console.error('Error loading calendar data:', error);
                showError('Error cargando datos del calendario');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthEl.textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();

            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            calendarDays.innerHTML = '';

            // Empty cells
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendarDays.appendChild(emptyCell);
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= totalDays; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const cellDate = new Date(year, month, day);

                if (cellDate < today) {
                    dayCell.classList.add('disabled');
                } else {
                    // Check if we have data for this date
                    const dateData = calendarData[dateStr];

                    if (dateData && dateData.schedules && dateData.schedules.length > 0) {
                        dayCell.classList.add('has-data');

                        // Create tooltip
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip';

                        const dayNames = ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'];
                        const dayName = dayNames[cellDate.getDay()];

                        tooltip.innerHTML = `
                            <div class="tooltip-header">${dayName} ${day}/${month + 1}</div>
                            ${dateData.schedules.map(s => `
                                <div class="tooltip-schedule">
                                    <span class="tooltip-time">${s.time}</span>
                                    <span class="tooltip-operator">${s.operator || 'N/A'}</span>
                                    <span class="tooltip-price">${s.price || '-'}</span>
                                    ${s.quota ? `<span class="tooltip-quota">${s.quota}</span>` : ''}
                                </div>
                            `).join('')}
                        `;

                        dayCell.appendChild(tooltip);
                    }
                }

                calendarDays.appendChild(dayCell);
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorCard.hidden = false;
            setTimeout(() => { errorCard.hidden = true; }, 5000);
        }

        // Event listeners
        tourSelect.addEventListener('change', (e) => {
            selectedTourId = parseInt(e.target.value);
            loadCalendarData();
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        refreshBtn.addEventListener('click', async () => {
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Actualizando...';

            try {
                const response = await fetch(`${API_URL}/api/scrape/manual`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Actualizacion iniciada. Los datos se actualizaran en unos minutos.');
                    // Reload after a delay
                    setTimeout(() => {
                        loadCalendarData();
                    }, 30000);
                }
            } catch (error) {
                showError('Error iniciando actualizacion');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Actualizar Datos Ahora';
            }
        });

        // Initialize
        loadTours();
    </script>
</body>
</html>
