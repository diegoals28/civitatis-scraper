<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civitatis - Comparador de Operadores</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Comparador de Operadores</h1>
            <p class="subtitle">Selecciona fechas y compara operadores de tours</p>
        </header>

        <main>
            <div class="controls-section">
                <div class="form-group">
                    <label for="tour-select">Tour</label>
                    <select id="tour-select">
                        <option value="https://www.civitatis.com/es/roma/visita-guiada-roma-antigua/">Coliseo, Foro y Palatino</option>
                        <option value="https://www.civitatis.com/es/roma/visita-guiada-vaticano/">Museos Vaticanos y Capilla Sixtina</option>
                        <option value="https://www.civitatis.com/es/roma/tour-coliseo-arena-gladiadores/">Coliseo + Arena de Gladiadores</option>
                    </select>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <button type="button" id="prev-month" class="calendar-nav">&lt;</button>
                        <span id="current-month">Enero 2026</span>
                        <button type="button" id="next-month" class="calendar-nav">&gt;</button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Lun</span>
                        <span>Mar</span>
                        <span>Mie</span>
                        <span>Jue</span>
                        <span>Vie</span>
                        <span>Sab</span>
                        <span>Dom</span>
                    </div>
                    <div id="calendar-days" class="calendar-days"></div>
                </div>

                <div class="selected-dates-info">
                    <span id="selected-count">0</span> fechas seleccionadas
                    <button type="button" id="clear-dates" class="btn-small">Limpiar</button>
                </div>

                <div class="action-buttons">
                    <button type="button" id="analyze-btn" class="btn-primary">
                        <span class="btn-text">Analizar Fechas</span>
                        <span class="btn-loading" hidden>
                            <span class="spinner"></span>
                            Analizando...
                        </span>
                    </button>
                    <button type="button" id="export-btn" class="btn-secondary" disabled>
                        Exportar Excel
                    </button>
                </div>
            </div>

            <div id="error-message" class="error-card" hidden>
                <strong>Error:</strong> <span id="error-text"></span>
            </div>

            <div id="progress-section" hidden>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <p id="progress-text">Analizando fecha 1 de 5...</p>
            </div>

            <div id="results-section" hidden>
                <h2>Resultados</h2>
                <div class="table-wrapper">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Horario</th>
                                <th>Operador</th>
                                <th>Precio</th>
                                <th>Plazas</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // State
        let currentDate = new Date();
        let selectedDates = new Set();
        let allResults = [];

        // DOM Elements
        const tourSelect = document.getElementById('tour-select');
        const calendarDays = document.getElementById('calendar-days');
        const currentMonthEl = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const selectedCountEl = document.getElementById('selected-count');
        const clearDatesBtn = document.getElementById('clear-dates');
        const analyzeBtn = document.getElementById('analyze-btn');
        const exportBtn = document.getElementById('export-btn');
        const errorCard = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const progressSection = document.getElementById('progress-section');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultsSection = document.getElementById('results-section');
        const resultsBody = document.getElementById('results-body');

        // Month names in Spanish
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // Initialize calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthEl.textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();

            // Get day of week for first day (0=Sunday, adjust for Monday start)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            calendarDays.innerHTML = '';

            // Empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendarDays.appendChild(emptyCell);
            }

            // Days of the month
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= totalDays; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const cellDate = new Date(year, month, day);

                // Disable past dates
                if (cellDate < today) {
                    dayCell.classList.add('disabled');
                } else {
                    dayCell.dataset.date = dateStr;

                    if (selectedDates.has(dateStr)) {
                        dayCell.classList.add('selected');
                    }

                    dayCell.addEventListener('click', () => toggleDate(dateStr, dayCell));
                }

                calendarDays.appendChild(dayCell);
            }
        }

        function toggleDate(dateStr, element) {
            if (selectedDates.has(dateStr)) {
                selectedDates.delete(dateStr);
                element.classList.remove('selected');
            } else {
                selectedDates.add(dateStr);
                element.classList.add('selected');
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            selectedCountEl.textContent = selectedDates.size;
            analyzeBtn.disabled = selectedDates.size === 0;
        }

        // Navigation
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        clearDatesBtn.addEventListener('click', () => {
            selectedDates.clear();
            renderCalendar();
            updateSelectedCount();
        });

        // Analyze dates
        analyzeBtn.addEventListener('click', async () => {
            if (selectedDates.size === 0) return;

            const url = tourSelect.value;
            const dates = Array.from(selectedDates).sort();

            // Reset state
            errorCard.hidden = true;
            resultsSection.hidden = true;
            allResults = [];

            // Show loading
            analyzeBtn.querySelector('.btn-text').hidden = true;
            analyzeBtn.querySelector('.btn-loading').hidden = false;
            analyzeBtn.disabled = true;
            exportBtn.disabled = true;

            progressSection.hidden = false;
            progressFill.style.width = '0%';

            try {
                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    progressText.textContent = `Analizando fecha ${i + 1} de ${dates.length}...`;
                    progressFill.style.width = `${((i) / dates.length) * 100}%`;

                    const response = await fetch('/api/scrape', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, date, language: 'es' })
                    });

                    const data = await response.json();

                    if (data.success && data.data) {
                        data.data.forEach(item => {
                            allResults.push({
                                date: date,
                                time: item.time,
                                operator: item.operator,
                                price: item.price,
                                quota: item.quota || null
                            });
                        });
                    }

                    progressFill.style.width = `${((i + 1) / dates.length) * 100}%`;
                }

                displayResults();
                exportBtn.disabled = allResults.length === 0;

            } catch (error) {
                errorText.textContent = error.message;
                errorCard.hidden = false;
            } finally {
                analyzeBtn.querySelector('.btn-text').hidden = false;
                analyzeBtn.querySelector('.btn-loading').hidden = true;
                analyzeBtn.disabled = false;
                progressSection.hidden = true;
            }
        });

        function displayResults() {
            resultsBody.innerHTML = '';

            if (allResults.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="5">No se encontraron resultados</td></tr>';
                resultsSection.hidden = false;
                return;
            }

            // Group results by date
            const groupedByDate = {};
            allResults.forEach(result => {
                if (!groupedByDate[result.date]) {
                    groupedByDate[result.date] = [];
                }
                groupedByDate[result.date].push(result);
            });

            // Sort dates
            const sortedDates = Object.keys(groupedByDate).sort();

            sortedDates.forEach(date => {
                const results = groupedByDate[date];
                const dateParts = date.split('-');
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'];
                const dateObj = new Date(date);
                const dayName = dayNames[dateObj.getDay()];
                const formattedDate = `${dayName} ${dateParts[2]}/${dateParts[1]}`;

                // Add date header row
                const headerRow = document.createElement('tr');
                headerRow.className = 'date-header-row';
                headerRow.innerHTML = `<td colspan="5" class="date-header">${formattedDate}</td>`;
                resultsBody.appendChild(headerRow);

                // Add results for this date
                results.forEach(result => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td></td>
                        <td>${result.time || 'N/A'}</td>
                        <td>${result.operator || 'Desconocido'}</td>
                        <td>${result.price || '-'}</td>
                        <td>${result.quota ? `<span class="quota-badge">${result.quota}</span>` : '-'}</td>
                    `;
                    resultsBody.appendChild(row);
                });
            });

            resultsSection.hidden = false;
        }

        // Export to Excel
        exportBtn.addEventListener('click', () => {
            if (allResults.length === 0) return;

            // Create CSV content
            let csv = 'Fecha,Horario,Operador,Precio,Plazas\n';

            allResults.forEach(r => {
                const dateParts = r.date.split('-');
                const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                const quota = r.quota || '';
                csv += `"${formattedDate}","${r.time}","${r.operator}","${r.price || ''}","${quota}"\n`;
            });

            // Download
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);

            const tourName = tourSelect.options[tourSelect.selectedIndex].text.replace(/[^a-zA-Z0-9]/g, '_');
            link.download = `civitatis_${tourName}_${new Date().toISOString().split('T')[0]}.csv`;

            link.click();
        });

        // Initialize
        renderCalendar();
        updateSelectedCount();
    </script>
</body>
</html>
